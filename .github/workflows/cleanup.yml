name: Cleanup Dev Boxes

on:
  workflow_dispatch:
    inputs:
      confirm:
        description: 'Type "DELETE ALL" to confirm'
        required: true
        type: string

jobs:
  cleanup:
    runs-on: ubuntu-latest
    steps:
      - name: Validate confirmation
        run: |
          if [ "${{ github.event.inputs.confirm }}" != "DELETE ALL" ]; then
            echo "ERROR: Confirmation failed. You must type 'DELETE ALL' exactly."
            exit 1
          fi

      - name: Install hcloud CLI
        run: |
          wget -q https://github.com/hetznercloud/cli/releases/latest/download/hcloud-linux-amd64.tar.gz
          tar -xzf hcloud-linux-amd64.tar.gz
          sudo mv hcloud /usr/local/bin/

      - name: Delete all managed servers
        env:
          HCLOUD_TOKEN: ${{ secrets.HETZNER_API_TOKEN }}
        run: |
          echo "Finding servers managed by dev-box-provisioner..."

          # Get all servers with the managed-by label
          servers=$(hcloud server list -o noheader -o columns=id,name -l managed-by=dev-box-provisioner)

          if [ -z "$servers" ]; then
            echo "No servers found to delete"
          else
            echo "Found servers:"
            echo "$servers"
            echo ""

            # Delete each server
            echo "$servers" | while read -r id name; do
              echo "Deleting server: $name (ID: $id)"
              hcloud server delete "$id"
              echo "✓ Deleted $name"
            done
            echo ""
          fi

          # Delete all managed SSH keys
          echo "Finding managed SSH keys..."
          keys=$(hcloud ssh-key list -o noheader -o columns=name -l managed-by=dev-box-provisioner)

          if [ -z "$keys" ]; then
            echo "No SSH keys found to delete"
          else
            echo "Found SSH keys:"
            echo "$keys"
            echo ""

            echo "$keys" | while read -r key_name; do
              if [ -n "$key_name" ]; then
                echo "Deleting SSH key: $key_name"
                hcloud ssh-key delete "$key_name"
                echo "✓ Deleted $key_name"
              fi
            done
          fi

          echo ""
          echo "All managed resources deleted"
